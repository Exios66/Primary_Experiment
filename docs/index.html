<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Advanced Eye Tracking Experiment</title>
    
    <!-- Modern dependencies -->
    <script src="https://unpkg.com/psychojs@2023.2.3/dist/psychojs.js"></script>
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
      :root {
        --primary-color: #2563eb;
        --secondary-color: #1e40af;
        --background-color: #0f172a;
        --text-color: #f8fafc;
        --error-color: #ef4444;
        --success-color: #22c55e;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        line-height: 1.6;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
      }

      .header {
        text-align: center;
        margin-bottom: 3rem;
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }

      .experiment-status {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 2rem;
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--primary-color);
        color: white;
      }

      .btn:hover {
        background: var(--secondary-color);
        transform: translateY(-1px);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .progress-container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        height: 8px;
        margin: 1rem 0;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        background: var(--primary-color);
        transition: width 0.3s ease;
        width: 0%;
      }

      .calibration-point {
        position: absolute;
        width: 20px;
        height: 20px;
        background: var(--primary-color);
        border-radius: 50%;
        transform: translate(-50%, -50%);
      }

      .export-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        align-items: center;
        margin-top: 2rem;
      }

      .export-btn {
        background: transparent;
        border: 2px solid var(--primary-color);
        color: var(--text-color);
      }

      .export-btn:hover {
        background: var(--primary-color);
      }

      .notification {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 1rem;
        border-radius: 6px;
        background: var(--success-color);
        color: white;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .notification.show {
        opacity: 1;
      }

      .error {
        background: var(--error-color);
      }

      @media (max-width: 768px) {
        .container {
          padding: 1rem;
        }

        h1 {
          font-size: 2rem;
        }

        .controls {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Eye Tracking Experiment</h1>
        <p>Advanced gaze tracking using WebGazer.js and PsychoJS</p>
      </div>

      <div class="experiment-status">
        <h2>Status</h2>
        <div class="progress-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
        <p id="statusText">Initializing experiment...</p>
      </div>

      <div class="controls">
        <button class="btn" id="startBtn">Start Experiment</button>
        <button class="btn" id="calibrateBtn" disabled>Calibrate</button>
        <button class="btn" id="abortBtn" disabled>Stop Experiment</button>
      </div>

      <div id="experimentContainer"></div>

      <div class="export-container" id="exportContainer" style="display: none;">
        <button class="btn export-btn" id="exportCSV">Download CSV Data</button>
        <button class="btn export-btn" id="exportJSON">Download JSON Data</button>
      </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
      // Global state
      let psychoJS;
      let experimentWindow;
      let gazeData = [];
      let calibrationData = [];
      let isExperimentRunning = false;
      let currentTrial = 0;

      // Configuration
      const config = {
        fullscreen: true,
        backgroundColor: '#0f172a',
        frameRate: 60,
        calibrationPoints: 9,
        trialCount: 5,
        sampleRate: 30
      };

      // UI Elements
      const ui = {
        startBtn: document.getElementById('startBtn'),
        calibrateBtn: document.getElementById('calibrateBtn'),
        abortBtn: document.getElementById('abortBtn'),
        progressBar: document.getElementById('progressBar'),
        statusText: document.getElementById('statusText'),
        notification: document.getElementById('notification'),
        exportContainer: document.getElementById('exportContainer')
      };

      // Initialize WebGazer
      async function initializeWebGazer() {
        try {
          await webgazer.setGazeListener((data, timestamp) => {
            if (data && isExperimentRunning) {
              gazeData.push({
                timestamp,
                x: data.x,
                y: data.y,
                trial: currentTrial
              });
            }
          }).begin();

          // Configure WebGazer
          webgazer.showVideo(false)
                  .showFaceOverlay(false)
                  .showFaceFeedbackBox(false)
                  .showPredictionPoints(false);

          return true;
        } catch (error) {
          showNotification('Failed to initialize WebGazer: ' + error.message, true);
          return false;
        }
      }

      // Initialize PsychoJS
      function initializePsychoJS() {
        psychoJS = new PsychoJS({
          debug: true
        });

        experimentWindow = new psychoJS.visual.Window({
          size: [window.innerWidth, window.innerHeight],
          fullscr: config.fullscreen,
          color: new psychoJS.Color(config.backgroundColor),
          units: 'norm'
        });

        return true;
      }

      // Calibration procedure
      async function runCalibration() {
        const points = [
          [-0.8, 0.8], [0, 0.8], [0.8, 0.8],
          [-0.8, 0], [0, 0], [0.8, 0],
          [-0.8, -0.8], [0, -0.8], [0.8, -0.8]
        ];

        calibrationData = [];
        
        for (let i = 0; i < points.length; i++) {
          const point = points[i];
          
          // Create calibration point
          const dot = new psychoJS.visual.Circle({
            win: experimentWindow,
            radius: 0.02,
            pos: point,
            fillColor: new psychoJS.Color('white'),
            lineWidth: 0
          });

          // Show point
          dot.draw();
          experimentWindow.flip();

          // Wait for fixation
          await new Promise(resolve => setTimeout(resolve, 1000));

          // Collect samples
          const samples = [];
          for (let j = 0; j < 10; j++) {
            const prediction = await webgazer.getCurrentPrediction();
            if (prediction) {
              samples.push({
                x: prediction.x,
                y: prediction.y
              });
            }
            await new Promise(resolve => setTimeout(resolve, 50));
          }

          // Calculate average
          if (samples.length > 0) {
            const avgX = samples.reduce((sum, s) => sum + s.x, 0) / samples.length;
            const avgY = samples.reduce((sum, s) => sum + s.y, 0) / samples.length;
            
            calibrationData.push({
              target: point,
              measured: [avgX, avgY]
            });
          }

          // Update progress
          updateProgress((i + 1) / points.length * 100);
        }

        return calibrationData.length === points.length;
      }

      // Run a single trial
      async function runTrial(trialNumber) {
        currentTrial = trialNumber;
        
        // Show fixation cross
        const fixation = new psychoJS.visual.TextStim({
          win: experimentWindow,
          text: '+',
          height: 0.1,
          color: new psychoJS.Color('white')
        });

        fixation.draw();
        experimentWindow.flip();
        await new Promise(resolve => setTimeout(resolve, 1000));

        // Show stimulus
        const stimulus = new psychoJS.visual.TextStim({
          win: experimentWindow,
          text: `Trial ${trialNumber}`,
          height: 0.1,
          color: new psychoJS.Color('white')
        });

        stimulus.draw();
        experimentWindow.flip();
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Inter-trial interval
        experimentWindow.flip();
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      // Export data
      function exportData() {
        // CSV Export
        const csvContent = "data:text/csv;charset=utf-8," + 
          "timestamp,x,y,trial\n" +
          gazeData.map(row => 
            `${row.timestamp},${row.x},${row.y},${row.trial}`
          ).join("\n");

        const csvLink = document.createElement('a');
        csvLink.href = encodeURI(csvContent);
        csvLink.download = 'gaze_data.csv';
        csvLink.click();

        // JSON Export
        const jsonContent = "data:text/json;charset=utf-8," + 
          encodeURIComponent(JSON.stringify(gazeData));

        const jsonLink = document.createElement('a');
        jsonLink.href = jsonContent;
        jsonLink.download = 'gaze_data.json';
        jsonLink.click();
      }

      // UI Updates
      function updateProgress(percent) {
        ui.progressBar.style.width = `${percent}%`;
      }

      function showNotification(message, isError = false) {
        ui.notification.textContent = message;
        ui.notification.classList.toggle('error', isError);
        ui.notification.classList.add('show');
        setTimeout(() => ui.notification.classList.remove('show'), 3000);
      }

      function resetUI() {
        ui.calibrateBtn.disabled = true;
        ui.abortBtn.disabled = true;
        ui.progressBar.style.width = '0%';
        ui.statusText.textContent = 'Experiment ready';
        ui.exportContainer.style.display = 'none';
      }

      // Event Handlers
      ui.startBtn.addEventListener('click', async () => {
        try {
          const webgazerInitialized = await initializeWebGazer();
          const psychojsInitialized = initializePsychoJS();

          if (webgazerInitialized && psychojsInitialized) {
            ui.calibrateBtn.disabled = false;
            ui.abortBtn.disabled = false;
            showNotification('Experiment initialized successfully');
          }
        } catch (error) {
          showNotification(error.message, true);
        }
      });

      ui.calibrateBtn.addEventListener('click', async () => {
        try {
          ui.statusText.textContent = 'Calibrating...';
          const calibrationSuccess = await runCalibration();
          
          if (calibrationSuccess) {
            showNotification('Calibration completed successfully');
            isExperimentRunning = true;
            
            // Run trials
            for (let trial = 1; trial <= config.trialCount; trial++) {
              if (!isExperimentRunning) break;
              await runTrial(trial);
              updateProgress(trial / config.trialCount * 100);
            }

            // Show export options
            ui.exportContainer.style.display = 'flex';
          }
        } catch (error) {
          showNotification(error.message, true);
        }
      });

      ui.abortBtn.addEventListener('click', () => {
        isExperimentRunning = false;
        webgazer.end();
        showNotification('Experiment aborted');
        resetUI();
      });

      ui.exportCSV.addEventListener('click', () => exportData());
      ui.exportJSON.addEventListener('click', () => exportData());

      // Handle window unload
      window.addEventListener('beforeunload', () => {
        if (webgazer) webgazer.end();
        if (psychoJS) psychoJS.quit();
      });
    </script>
  </body>
</html>